groups:
  - name: f5xc_loadbalancer_alerts
    interval: 60s
    rules:
      # Critical Alerts - HTTP Load Balancers
      - alert: HTTPLoadBalancerHighErrorRate
        expr: |
          (f5xc_http_lb_error_rate / f5xc_http_lb_request_rate) > 0.05
          and f5xc_http_lb_request_rate > 1
        for: 5m
        labels:
          severity: critical
          component: loadbalancer
          lb_type: http
        annotations:
          summary: "High error rate on HTTP load balancer {{ $labels.load_balancer }}"
          description: |
            Error rate on {{ $labels.load_balancer }} ({{ $labels.direction }}) in namespace {{ $labels.namespace }}
            is {{ $value | humanizePercentage }} (over 5% threshold).
            Error rate: {{ with query (printf "f5xc_http_lb_error_rate{tenant='%s',namespace='%s',load_balancer='%s',site='%s',direction='%s'}" .Labels.tenant .Labels.namespace .Labels.load_balancer .Labels.site .Labels.direction) }}{{ . | first | value | humanize }}{{ end }}/s
            Request rate: {{ with query (printf "f5xc_http_lb_request_rate{tenant='%s',namespace='%s',load_balancer='%s',site='%s',direction='%s'}" .Labels.tenant .Labels.namespace .Labels.load_balancer .Labels.site .Labels.direction) }}{{ . | first | value | humanize }}{{ end }}/s
          runbook_url: https://github.com/f5xc-TenantOps/f5xc-prom-exporter/wiki/Runbook-HTTPLoadBalancerHighErrorRate

      - alert: HTTPLoadBalancerLowHealthScore
        expr: f5xc_http_lb_healthscore_overall{direction="downstream"} < 50
        for: 5m
        labels:
          severity: critical
          component: loadbalancer
          lb_type: http
        annotations:
          summary: "HTTP load balancer {{ $labels.load_balancer }} has critically low health score"
          description: |
            Overall health score for {{ $labels.load_balancer }} in namespace {{ $labels.namespace }}
            is {{ $value | humanize }}/100 (below 50). Immediate investigation required.
            Connectivity: {{ with query (printf "f5xc_http_lb_healthscore_connectivity{tenant='%s',namespace='%s',load_balancer='%s',site='%s',direction='%s'}" .Labels.tenant .Labels.namespace .Labels.load_balancer .Labels.site .Labels.direction) }}{{ . | first | value | humanize }}{{ end }}/100
            Performance: {{ with query (printf "f5xc_http_lb_healthscore_performance{tenant='%s',namespace='%s',load_balancer='%s',site='%s',direction='%s'}" .Labels.tenant .Labels.namespace .Labels.load_balancer .Labels.site .Labels.direction) }}{{ . | first | value | humanize }}{{ end }}/100
            Security: {{ with query (printf "f5xc_http_lb_healthscore_security{tenant='%s',namespace='%s',load_balancer='%s',site='%s',direction='%s'}" .Labels.tenant .Labels.namespace .Labels.load_balancer .Labels.site .Labels.direction) }}{{ . | first | value | humanize }}{{ end }}/100
            Reliability: {{ with query (printf "f5xc_http_lb_healthscore_reliability{tenant='%s',namespace='%s',load_balancer='%s',site='%s',direction='%s'}" .Labels.tenant .Labels.namespace .Labels.load_balancer .Labels.site .Labels.direction) }}{{ . | first | value | humanize }}{{ end }}/100
          runbook_url: https://github.com/f5xc-TenantOps/f5xc-prom-exporter/wiki/Runbook-LoadBalancerLowHealthScore

      # Warning Alerts - HTTP Load Balancers
      - alert: HTTPLoadBalancerHighLatency
        expr: f5xc_http_lb_latency_p95_seconds{direction="downstream"} > 2 * avg_over_time(f5xc_http_lb_latency_p95_seconds{direction="downstream"}[1h] offset 1h)
        for: 10m
        labels:
          severity: warning
          component: loadbalancer
          lb_type: http
        annotations:
          summary: "High P95 latency on HTTP load balancer {{ $labels.load_balancer }}"
          description: |
            P95 latency on {{ $labels.load_balancer }} ({{ $labels.direction }}) in namespace {{ $labels.namespace }}
            is {{ $value | humanizeDuration }} (over 2x baseline). Performance degradation detected.
            P50: {{ with query (printf "f5xc_http_lb_latency_p50_seconds{tenant='%s',namespace='%s',load_balancer='%s',site='%s',direction='%s'}" .Labels.tenant .Labels.namespace .Labels.load_balancer .Labels.site .Labels.direction) }}{{ . | first | value | humanizeDuration }}{{ end }}
            P90: {{ with query (printf "f5xc_http_lb_latency_p90_seconds{tenant='%s',namespace='%s',load_balancer='%s',site='%s',direction='%s'}" .Labels.tenant .Labels.namespace .Labels.load_balancer .Labels.site .Labels.direction) }}{{ . | first | value | humanizeDuration }}{{ end }}
            P99: {{ with query (printf "f5xc_http_lb_latency_p99_seconds{tenant='%s',namespace='%s',load_balancer='%s',site='%s',direction='%s'}" .Labels.tenant .Labels.namespace .Labels.load_balancer .Labels.site .Labels.direction) }}{{ . | first | value | humanizeDuration }}{{ end }}
          runbook_url: https://github.com/f5xc-TenantOps/f5xc-prom-exporter/wiki/Runbook-HTTPLoadBalancerHighLatency

      - alert: HTTPLoadBalancerDegradedHealthScore
        expr: f5xc_http_lb_healthscore_overall{direction="downstream"} < 80 and f5xc_http_lb_healthscore_overall{direction="downstream"} >= 50
        for: 15m
        labels:
          severity: warning
          component: loadbalancer
          lb_type: http
        annotations:
          summary: "HTTP load balancer {{ $labels.load_balancer }} has degraded health score"
          description: |
            Overall health score for {{ $labels.load_balancer }} in namespace {{ $labels.namespace }}
            is {{ $value | humanize }}/100 (below 80). Performance or reliability issues detected.
            Connectivity: {{ with query (printf "f5xc_http_lb_healthscore_connectivity{tenant='%s',namespace='%s',load_balancer='%s',site='%s',direction='%s'}" .Labels.tenant .Labels.namespace .Labels.load_balancer .Labels.site .Labels.direction) }}{{ . | first | value | humanize }}{{ end }}/100
            Performance: {{ with query (printf "f5xc_http_lb_healthscore_performance{tenant='%s',namespace='%s',load_balancer='%s',site='%s',direction='%s'}" .Labels.tenant .Labels.namespace .Labels.load_balancer .Labels.site .Labels.direction) }}{{ . | first | value | humanize }}{{ end }}/100
            Security: {{ with query (printf "f5xc_http_lb_healthscore_security{tenant='%s',namespace='%s',load_balancer='%s',site='%s',direction='%s'}" .Labels.tenant .Labels.namespace .Labels.load_balancer .Labels.site .Labels.direction) }}{{ . | first | value | humanize }}{{ end }}/100
            Reliability: {{ with query (printf "f5xc_http_lb_healthscore_reliability{tenant='%s',namespace='%s',load_balancer='%s',site='%s',direction='%s'}" .Labels.tenant .Labels.namespace .Labels.load_balancer .Labels.site .Labels.direction) }}{{ . | first | value | humanize }}{{ end }}/100
          runbook_url: https://github.com/f5xc-TenantOps/f5xc-prom-exporter/wiki/Runbook-LoadBalancerDegradedHealthScore

      # Critical Alerts - TCP Load Balancers
      - alert: TCPLoadBalancerHighErrorRate
        expr: |
          (f5xc_tcp_lb_error_rate / f5xc_tcp_lb_connection_rate) > 0.05
          and f5xc_tcp_lb_connection_rate > 1
        for: 5m
        labels:
          severity: critical
          component: loadbalancer
          lb_type: tcp
        annotations:
          summary: "High error rate on TCP load balancer {{ $labels.load_balancer }}"
          description: |
            Error rate on {{ $labels.load_balancer }} ({{ $labels.direction }}) in namespace {{ $labels.namespace }}
            is {{ $value | humanizePercentage }} (over 5% threshold).
            Error rate: {{ with query (printf "f5xc_tcp_lb_error_rate{tenant='%s',namespace='%s',load_balancer='%s',site='%s',direction='%s'}" .Labels.tenant .Labels.namespace .Labels.load_balancer .Labels.site .Labels.direction) }}{{ . | first | value | humanize }}{{ end }}/s
            Connection rate: {{ with query (printf "f5xc_tcp_lb_connection_rate{tenant='%s',namespace='%s',load_balancer='%s',site='%s',direction='%s'}" .Labels.tenant .Labels.namespace .Labels.load_balancer .Labels.site .Labels.direction) }}{{ . | first | value | humanize }}{{ end }}/s
          runbook_url: https://github.com/f5xc-TenantOps/f5xc-prom-exporter/wiki/Runbook-TCPLoadBalancerHighErrorRate

      - alert: TCPLoadBalancerLowHealthScore
        expr: f5xc_tcp_lb_healthscore_overall{direction="downstream"} < 50
        for: 5m
        labels:
          severity: critical
          component: loadbalancer
          lb_type: tcp
        annotations:
          summary: "TCP load balancer {{ $labels.load_balancer }} has critically low health score"
          description: |
            Overall health score for {{ $labels.load_balancer }} in namespace {{ $labels.namespace }}
            is {{ $value | humanize }}/100 (below 50). Immediate investigation required.
          runbook_url: https://github.com/f5xc-TenantOps/f5xc-prom-exporter/wiki/Runbook-LoadBalancerLowHealthScore

      # Warning Alerts - UDP Load Balancers
      - alert: UDPLoadBalancerLowHealthScore
        expr: f5xc_udp_lb_healthscore_overall{direction="downstream"} < 80
        for: 15m
        labels:
          severity: warning
          component: loadbalancer
          lb_type: udp
        annotations:
          summary: "UDP load balancer {{ $labels.load_balancer }} has degraded health score"
          description: |
            Overall health score for {{ $labels.load_balancer }} in namespace {{ $labels.namespace }}
            is {{ $value | humanize }}/100 (below 80).
          runbook_url: https://github.com/f5xc-TenantOps/f5xc-prom-exporter/wiki/Runbook-LoadBalancerDegradedHealthScore

      # Collection Health
      - alert: LoadBalancerCollectionFailed
        expr: f5xc_lb_collection_success == 0
        for: 10m
        labels:
          severity: warning
          component: collector
        annotations:
          summary: "F5XC load balancer metrics collection failing"
          description: |
            Load balancer metrics collection has been failing for over 10 minutes.
            This may indicate API connectivity issues or permission problems.
          runbook_url: https://github.com/f5xc-TenantOps/f5xc-prom-exporter/wiki/Runbook-CollectionFailure
